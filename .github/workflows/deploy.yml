name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# è®¾ç½®æƒé™
permissions:
  contents: read
  pages: write
  id-token: write

# åªå…è®¸ä¸€ä¸ªå¹¶å‘éƒ¨ç½²ï¼Œè·³è¿‡æ­£åœ¨è¿›è¡Œçš„è¿è¡Œä¹‹é—´æ’é˜Ÿçš„è¿è¡Œ
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Build
      run: |
        echo "ğŸ” Current environment: ${{ github.environment }}"
        echo "ğŸ” Job environment: github-pages"
        
        # æ£€æŸ¥åŸå§‹æ–‡ä»¶
        echo "ğŸ“„ Before replacement:"
        grep -n "DASHSCOPE_API_KEY_PLACEHOLDER" script.js || echo "Placeholder not found"
        
        # æ›¿æ¢API Keyå ä½ç¬¦
        if [ -n "${{ secrets.DASHSCOPE_API_KEY }}" ]; then
          echo "âœ… DASHSCOPE_API_KEY secret is available"
          echo "ğŸ”‘ Key starts with: $(echo '${{ secrets.DASHSCOPE_API_KEY }}' | cut -c1-3)"
          sed -i "s/DASHSCOPE_API_KEY_PLACEHOLDER/${{ secrets.DASHSCOPE_API_KEY }}/g" script.js
          echo "âœ… API Key replacement completed"
        else
          echo "âŒ DASHSCOPE_API_KEY secret not found in github-pages environment"
          echo "ğŸ” Available secrets context:"
          echo "Secrets context exists: ${{ toJson(secrets) != '{}' }}"
          exit 1
        fi
        
        # æ£€æŸ¥æ›¿æ¢ç»“æœ
        echo "ğŸ“„ After replacement:"
        if grep -q "DASHSCOPE_API_KEY_PLACEHOLDER" script.js; then
          echo "âŒ Placeholder still exists"
          exit 1
        else
          echo "âœ… Placeholder successfully replaced"
        fi